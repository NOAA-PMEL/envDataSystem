{% extends 'envdaq/base.html' %}

{% block header %}
    <h1>envDSys : Controller : {{ controller_label|cut:'"' }}</h1>
{% endblock %}

{% block status %}
    <div class="card">
        <textarea readonly class="status-box" id="status-window" cols="60" rows="5"></textarea><br/>
        {% comment %} <textarea id="status-window" width="100%" rows="5"></textarea><br/> {% endcomment %}
        {% comment %} <div id="status-window" class="status-box"></div> {% endcomment %}
        <button id="refresh-status-button" class="opsbutton" value="Refresh" onclick=reqest_status()>Refresh</button>
    </div>
{% endblock %}

{% block data %}
    <div class="card">
    <b><p id="time-stamp"></p></b><br/>
    <div id="meas-table">

        {% comment %} <script>build_data_table()</script> {% endcomment %}
    </div>
    </div>
{% endblock %}

{% block plots %}
    <div class="card">
        {% comment %} {{ plot_script | safe }} {% endcomment %}
        {% comment %} <div class="iframe-container">
            <div id=plot_container>    
                
            </div>
        </div> {% endcomment %}
    </div>
{% endblock %}

{% block controls %}
    <div class="card">
        <div id="controls-table"></div>
        {% comment %} <label for="input_temperature_sp">Input Temperature SP</label>
        <input id="input_temperature_sp" type="number" name="input_temperature_sp" min="10.0" max="30.0" value="25.0">
        <input id"input_temperature_sp_set" type="button" value="Set"> {% endcomment %}
        {% comment %} <div id="run-control> {% endcomment %}
            <div class="opsbutton-container">
                <input type="button" id="start-stop-button" value="Start" class="opsbutton stopped" onclick=opsButtonRequest(this)>
            </div>
        {% comment %} </div> {% endcomment %}
    </div>
{% endblock %}

{% block rawdata %}
    <button class="accordion"><em>Raw data from server</em></button>
    <div class="panel">
        <textarea readonly class="status-box" id="metadata-window" cols="10" rows="10"></textarea>
        <textarea readonly class="status-box" id="data-window" cols="10" rows="10"></textarea>
    </div>
{% endblock %}


{% block content %}

    <script>
        
        window.onload=init;

        var wait_for_setup = true;
        
        function init() {
            
            {% comment %} build_table() {% endcomment %}

            {% comment %} {{ instrument_label_json }} {% endcomment %}
            setup_accordions()
            build_data_table()
            // build_controls_table()
            //reqest_status()
            wait_for_setup = false
        }

       
        function build_data_table() {
            // var measurements = JSON.parse('{{ instrument_measurements | escapejs }}')
            // var tablediv = document.getElementById('meas-table')[0];
            var tablediv = document.getElementById('meas-table');
            
            var table = document.createElement('table');
            table.setAttribute('id', 'data-table');
            table.setAttribute('class', 'daq-table')
            //table.setAttribute('style', 'border-collapse: collapse; border-radius: 10px; overflow: hidden')

            var caption = table.createCaption()
            caption.innerHTML = "<em>Data</em>"

            var header = table.createTHead();
            var row = header.insertRow(0);
            row.setAttribute('style', 'border: 1px solid black')
            var cell = row.insertCell(0);
            cell.setAttribute('id', 'data-table-namecol');
            cell.setAttribute('style', 'border: 1px solid black; text-align: center;')
            cell.innerHTML = "<b>Name</b>";
            cell = row.insertCell(1);
            cell.setAttribute('style', 'border: 1px solid black; text-align: center;')
            cell.innerHTML = "<b>Value</b>";
            cell.setAttribute('id', 'data-table-valuecol');
            cell.innerHTML = "Value"
            cell = row.insertCell(2);
            cell.setAttribute('style', 'border: 1px solid black; text-align: center;')
            cell.innerHTML = "<b>Units</b>";
            cell.setAttribute('id', 'data-table-unitcol');

            tablediv.appendChild(table);
        }


        // websocket communication

        var controller_name = {{ controller_name }}

        console.log(controller_name)
        var websocket = new WebSocket(
            'ws://' + window.location.host +
            '/ws/envdaq/controller/'+controller_name+'/');

        websocket.onmessage = function(e) {
            var data = JSON.parse(e.data)
            console.log(data)
            // document.getElementById('data-window').innerHTML = data
            if (data['message']['SUBJECT'] == 'DATA') {
                console.log(data)    
            } else if (data['message']['SUBJECT'] == 'STATUS') {

                if (data.message.BODY.purpose == 'UPDATE') {
                   {% comment %} console.log(JSON.stringify(data.message.BODY.status)) {% endcomment %}
                    var status = data.message.BODY.status
                    update_status(status)
                }
            }
        }

        websocket.onopen = function(event) {
            console.log('Connected to: ' + event.currentTarget.url)
            while (wait_for_setup) {}
            
            reqest_status()
        }


        function reqest_status() {

            var message = {}
            message['SUBJECT'] = 'STATUS'
            message['BODY'] = {
                'purpose': 'REQUEST',
           }
            console.log(JSON.stringify(message))
            websocket.send(
                JSON.stringify({'message': message})
            )

        };

        function update_status(status) {
            console.log(status)
            runstate = status.run_status
            opsButtonSet(runstate)
            document.getElementById("status-window").value = JSON.stringify(status)
            document.getElementById("status-window").innerHTML = JSON.stringify(status)
        };

        function opsButtonRequest(obj) {
            button = document.getElementById('start-stop-button')
            var req = "STOP"
            if (button.value == "Start") {
                req = "START"
            } 

            var message = {}
            message['SUBJECT'] = 'RUNCONTROLS'
            message['BODY'] = {
                'purpose': 'REQUEST',
                'control': 'start_stop',
                'value': req,
            }

            websocket.send(
                JSON.stringify({'message': message})
            )

        }

        function opsButtonSet(runstate) {
            button = document.getElementById('start-stop-button')

            var class_val = 'opsbutton started'
            var value = "Stop"

            if (runstate == "STOPPED") {
                class_val = 'opsbutton stopped'
                value = "Start"
            }
            button.value = value
            button.className = class_val
        }

    </script>

{% endblock %}